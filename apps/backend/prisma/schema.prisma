// Schema de Prisma para CIO MVP
// Base de datos: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// ENUMS PARA SISTEMA DE PLANES
// ==========================================

enum PlanType {
  FREEMIUM
  PREMIUM
}

enum SubscriptionStatus {
  ACTIVE
  EXPIRED
  CANCELLED
}

// ==========================================
// MODELOS
// ==========================================

model User {
  id        String   @id @default(cuid())
  phone     String   @unique
  
  // Datos de identidad (se piden en onboarding)
  name      String?              // Nombre del usuario
  email     String?  @unique     // Email (se pide al agotar freemium)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones existentes
  profile         UserProfile?
  sessions        Session[]
  alert           AlertPreference?
  searchLogs      JobSearchLog[]
  sentJobs        SentJob[]
  chatMessages    ChatMessage[]
  pendingAlerts   PendingJobAlert[]
  
  // Nuevas relaciones para sistema de planes
  subscription  Subscription?
  transactions  Transaction[]

  @@map("users")
}

// ==========================================
// MODELO DE SUSCRIPCIÓN
// ==========================================

model Subscription {
  id                String             @id @default(cuid())
  userId            String             @unique
  
  // Plan actual
  plan              PlanType           @default(FREEMIUM)
  
  // Control de usos freemium (5 búsquedas O 5 días hábiles)
  freemiumUsesLeft  Int                @default(5)
  freemiumStartDate DateTime           @default(now())
  freemiumExpired   Boolean            @default(false)
  
  // Control de recordatorio freemium (23 horas después de expirar)
  freemiumExpiredSentAt  DateTime?     // Cuándo se envió el mensaje FREEMIUM_EXPIRED
  freemiumReminderSent   Boolean       @default(false) // Si ya se envió el recordatorio
  
  // Control de usos premium (5 por semana)
  premiumUsesLeft   Int                @default(0)
  premiumWeekStart  DateTime?
  
  // Fechas de suscripción premium
  premiumStartDate  DateTime?
  premiumEndDate    DateTime?          // Null = sin expiración
  
  // Estado de la suscripción
  status            SubscriptionStatus @default(ACTIVE)
  
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

// ==========================================
// MODELO DE TRANSACCIONES (PAGOS WOMPI)
// ==========================================

model Transaction {
  id              String    @id @default(cuid())
  userId          String?                          // Puede ser null hasta vincular por email
  
  // Datos de Wompi
  wompiId         String    @unique                // ID único de transacción en Wompi
  wompiReference  String                           // Referencia de pago
  wompiStatus     String                           // APPROVED, DECLINED, PENDING, VOIDED, ERROR
  
  // Datos del pago
  amount          Int                              // Monto en centavos (COP)
  currency        String    @default("COP")
  paymentMethod   String?                          // PSE, CARD, NEQUI, BANCOLOMBIA, etc.
  email           String                           // Email usado en el pago
  
  // Vinculación con usuario
  linkedAt        DateTime?                        // Fecha cuando se vinculó al usuario
  
  // Metadata completa de Wompi
  rawPayload      Json?                            // Payload completo del webhook
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  user            User?     @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([email])
  @@index([wompiReference])
  @@map("transactions")
}

model UserProfile {
  id              String   @id @default(cuid())
  userId          String   @unique
  role            String?
  location        String?
  jobType         String?  // full_time, part_time, internship, freelance
  minSalary       Int?
  workMode        String?  // [DESACTIVADO] presencial, remoto, hibrido, sin_preferencia - Campo mantenido por compatibilidad pero no usado actualmente
  experienceLevel String?  // none, junior, mid, senior, lead
  createdFromCV   Boolean  @default(false)
  cvUrl           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_profiles")
}

model Session {
  id         String   @id @default(cuid())
  userId     String
  state      String   // enum-like: NEW, ASK_DEVICE, ASK_TERMS, ASK_ROLE, ASK_LOCATION, ASK_JOB_TYPE, ASK_MIN_SALARY, ASK_ALERT_TIME, READY
  deviceType String?  // MOBILE o DESKTOP
  data       Json?    // para info temporal
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model AlertPreference {
  id               String    @id @default(cuid())
  userId           String    @unique
  alertFrequency   String    @default("daily") // daily, every_3_days, weekly, monthly
  alertTimeLocal   String    // "07:00"
  timezone         String    @default("America/Bogota")
  enabled          Boolean   @default(true)
  lastNotification DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("alert_preferences")
}

model JobSearchLog {
  id          String   @id @default(cuid())
  userId      String
  executedAt  DateTime @default(now())
  query       String
  resultCount Int
  success     Boolean  @default(true)
  errorMsg    String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("job_search_logs")
}

model SentJob {
  id        String   @id @default(cuid())
  userId    String
  url       String
  title     String
  company   String?
  sentAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, url])
  @@map("sent_jobs")
}

// ==========================================
// MODELO DE MENSAJES DE CHAT (HISTORIAL)
// ==========================================

model ChatMessage {
  id              String   @id @default(cuid())
  userId          String
  
  // Datos del mensaje
  direction       String   // "inbound" (usuario -> bot) o "outbound" (bot -> usuario)
  content         String   @db.Text // Contenido del mensaje
  
  // Contexto de la conversación
  conversationState String? // Estado de conversación en ese momento (ASK_NAME, ASK_ROLE, etc.)
  intent          String?  // Intención detectada (search, edit, cancel, etc.)
  
  // Metadata técnica
  messageId       String?  // ID del mensaje de WhatsApp (si aplica)
  isError         Boolean  @default(false)
  errorMessage    String?  @db.Text
  
  // Metadata adicional (JSON flexible para futuras extensiones)
  metadata        Json?    // Puede contener: búsqueda realizada, ofertas enviadas, etc.
  
  createdAt       DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt]) // Para consultas rápidas por usuario y fecha
  @@index([conversationState])
  @@map("chat_messages")
}

// ==========================================
// MODELO DE ADMINISTRADORES
// ==========================================

model AdminUser {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  name         String
  role         String   @default("ADMIN") // Para futuro RBAC
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("admin_users")
}

// ==========================================
// MODELO DE ALERTAS PENDIENTES (TEMPLATES)
// ==========================================

model PendingJobAlert {
  id        String    @id @default(cuid())
  userId    String
  jobs      Json      // Array de ofertas encontradas
  jobCount  Int       // Número de ofertas
  createdAt DateTime  @default(now())
  viewedAt  DateTime? // Cuándo el usuario pidió ver las ofertas
  sentAt    DateTime? // Cuándo se le enviaron las ofertas

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, viewedAt])
  @@map("pending_job_alerts")
}
